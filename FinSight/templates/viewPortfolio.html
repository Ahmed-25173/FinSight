{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ portfolio.name }} - FinSight</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #0a0f1c; color: #eaecef; font-family: 'Inter', sans-serif; }
    .card-hover { transition: all 0.3s ease-in-out; }
    .card-hover:hover { transform: translateY(-6px); box-shadow: 0 12px 24px rgba(30,144,255,0.35); }
    table th, table td { text-align: center; padding: 0.75rem; }
    table th { background-color: #1e90ff; color: white; font-weight: 600; font-size: 0.875rem; }
    table tbody tr:hover { background-color: #0d1323; transition: all 0.2s; }
    .progress-bar { height: 0.5rem; border-radius: 9999px; background-color: #1e90ff; }
    .top5-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.04); }
    .ticker { font-weight: 700; color: #e6f2ff; }
    .small-muted { color: #aab6c8; font-size: 0.85rem; }
    .fav-button { background: transparent; border: none; cursor: pointer; font-size: 1.25rem; }
  </style>
</head>
<body class="bg-[#0a0f1c] text-gray-200 font-sans">

<nav class="fixed w-full z-50 top-0 bg-transparent flex justify-between items-center px-8 py-4 shadow-sm">
  <div class="text-3xl md:text-4xl font-extrabold text-[#1e90ff] tracking-wide">FinSight</div>
  <div class="flex items-center space-x-3">
    <select class="bg-[#0b5ed7] text-white rounded-lg px-4 py-2 cursor-pointer">
      <option selected disabled>Portfolio</option>
      <option value="{% url 'viewPortfolio' %}">View Portfolio</option>
      <option value="{% url 'updatePortfolio' %}">Update Portfolio</option>
      <option value="{% url 'deletePortfolio' %}">Delete Portfolio</option>
      <option value="{% url 'createPortfolio' %}">Create Portfolio</option>
    </select>
    <a href="{% url 'home' %}" class="bg-[#0b5ed7] hover:bg-[#3c83f6] rounded-lg px-4 py-2 transition">Home</a>
    <a href="{% url 'favoriteStocksPage' %}" class="bg-[#0b5ed7] hover:bg-[#3c83f6] rounded-lg px-4 py-2 transition">Favorite Stocks</a>
    <a href="{% url 'update_profile' %}" class="bg-[#0b5ed7] hover:bg-[#3c83f6] rounded-lg px-4 py-2 transition">Update Profile</a>
    <a href="{% url 'changepassword' %}" class="bg-[#0b5ed7] hover:bg-[#3c83f6] rounded-lg px-4 py-2 transition">Change Password</a>
    <a href="{% url 'logout' %}" class="bg-[#0b5ed7] hover:bg-[#3c83f6] rounded-lg px-4 py-2 transition">Logout</a>
  </div>
</nav>

<main class="pt-28 px-6 md:px-12 space-y-8">

  <h1 class="text-3xl md:text-4xl font-extrabold text-[#1e90ff] mb-6">{{ portfolio.name }} Dashboard</h1>

  <!-- Portfolio summary cards -->
  <section class="grid md:grid-cols-5 gap-6">
    <div class="card-hover bg-[#101a2b] rounded-xl p-6 shadow-md border border-[#1a2238] flex flex-col items-start">
      <span class="text-gray-400 uppercase text-sm mb-2">Cash Balance</span>
      <span class="text-2xl md:text-3xl font-bold">${{ portfolio.cashBalance }}</span>
    </div>
    <div class="card-hover bg-[#101a2b] rounded-xl p-6 shadow-md border border-[#1a2238] flex flex-col items-start">
      <span class="text-gray-400 uppercase text-sm mb-2">Portfolio Value</span>
      <span class="text-2xl md:text-3xl font-bold">${{ total_portfolio_value }}</span>
    </div>
    <div class="card-hover bg-[#101a2b] rounded-xl p-6 shadow-md border border-[#1a2238] flex flex-col items-start">
      <span class="text-gray-400 uppercase text-sm mb-2">Total P&L</span>
      {% with stock_pnl=total_portfolio_pnl|floatformat:"2" %}
      <span class="text-2xl md:text-3xl font-bold {% if stock_pnl|stringformat:"s"|slice:":1" != "-" %}text-green-400{% else %}text-red-500{% endif %}">
        {% if stock_pnl|stringformat:"s"|slice:":1" != "-" %}▲{% else %}▼{% endif %} ${{ total_portfolio_pnl }}
      </span>
      {% endwith %}
    </div>
    <div class="card-hover bg-[#101a2b] rounded-xl p-6 shadow-md border border-[#1a2238] flex flex-col items-start">
      <span class="text-gray-400 uppercase text-sm mb-2">Total Holdings</span>
      <span class="text-2xl md:text-3xl font-bold">{{ stock_data|length }}</span>
    </div>
    <div class="card-hover bg-[#101a2b] rounded-xl p-6 shadow-md border border-[#1a2238] flex flex-col items-start">
      <span class="text-gray-400 uppercase text-sm mb-2">Last Price Update</span>
      {% if last_cache_time %}
        <span class="text-lg md:text-xl font-medium">{{ last_cache_time|date:"M j, Y H:i" }}</span>
      {% else %}
        <span class="text-lg md:text-xl font-medium">N/A</span>
      {% endif %}
    </div>
  </section>

  <!-- Top 5 Holdings -->
  <section class="mt-2">
    <h2 class="text-xl font-bold text-[#1e90ff] mb-4">Top 5 Holdings</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
      {% if top5 %}
        {% for t in top5 %}
        {% with pnl_str=t.pnl|stringformat:"s"|slice:":1" %}
        <div class="top5-card rounded-lg p-4">
          <div class="flex justify-between items-start">
            <div>
              <div class="ticker text-lg">{{ t.symbol }}</div>
              <div class="small-muted">Qty: {{ t.qty }} • Avg: ${{ t.avg_buy_price }}</div>
            </div>
            <div class="text-right">
              {% if pnl_str != "-" %}
                <div class="text-sm text-green-400 font-bold">▲ {{ t.pnl|floatformat:2 }}</div>
              {% else %}
                <div class="text-sm text-red-500 font-bold">▼ {{ t.pnl|floatformat:2 }}</div>
              {% endif %}
              <div class="small-muted text-xs">P&L</div>
            </div>
          </div>

          <div class="mt-3 flex items-center justify-between">
            <div class="text-2xl font-semibold">${{ t.value }}</div>
            <div class="text-right">
              <div class="text-sm small-muted">Weight</div>
              <div class="font-medium">{{ t.percent_by_value }}%</div>
            </div>
          </div>

          <div class="mt-3">
            <div class="bg-gray-700 rounded-full h-2 w-full">
              <div class="rounded-full h-2" style="width: {{ t.percent_by_value }}%; background: linear-gradient(90deg,#1e90ff,#3c83f6);"></div>
            </div>
          </div>
        </div>
        {% endwith %}
        {% endfor %}
      {% else %}
        <p class="text-gray-400">No holdings yet.</p>
      {% endif %}
    </div>
  </section>

  <!-- Top Gainer & Top Loser -->
  <section class="mt-8">
    <h2 class="text-xl font-bold text-[#1e90ff] mb-4">Top Gainer & Top Loser</h2>
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Top Gainer -->
      {% if top_gainer %}
      <div class="card-hover bg-[#101a2b] rounded-xl p-6 shadow-md border border-[#1a2238] flex flex-col">
        <span class="text-gray-400 uppercase text-sm mb-2">Top Gainer</span>
        <div class="flex justify-between items-center">
          <div>
            <div class="ticker text-lg">{{ top_gainer.symbol }}</div>
            <div class="small-muted">Qty: {{ top_gainer.owned_qty }} • Avg: ${{ top_gainer.avg_buy_price }}</div>
          </div>
          <div class="text-right text-green-400 font-bold text-xl">
            ▲ ${{ top_gainer.pnl|floatformat:2 }}
          </div>
        </div>
        <div class="mt-3">
          <div class="bg-gray-700 rounded-full h-2 w-full">
            <div class="rounded-full h-2" style="width: {{ top_gainer.percent }}%; background: linear-gradient(90deg,#32cd32,#00ff7f);"></div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Top Loser -->
      {% if top_loser %}
      <div class="card-hover bg-[#101a2b] rounded-xl p-6 shadow-md border border-[#1a2238] flex flex-col">
        <span class="text-gray-400 uppercase text-sm mb-2">Top Loser</span>
        <div class="flex justify-between items-center">
          <div>
            <div class="ticker text-lg">{{ top_loser.symbol }}</div>
            <div class="small-muted">Qty: {{ top_loser.owned_qty }} • Avg: ${{ top_loser.avg_buy_price }}</div>
          </div>
          <div class="text-right text-red-500 font-bold text-xl">
            ▼ ${{ top_loser.pnl|floatformat:2 }}
          </div>
        </div>
        <div class="mt-3">
          <div class="bg-gray-700 rounded-full h-2 w-full">
            <div class="rounded-full h-2" style="width: {{ top_loser.percent }}%; background: linear-gradient(90deg,#ff4c4c,#ff0000);"></div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- Investment Goal & Risk Tolerance -->
  <section class="grid md:grid-cols-2 gap-6">
    <div class="card-hover bg-[#101a2b] rounded-xl p-6 shadow-md border border-[#1a2238] flex flex-col">
      <span class="text-gray-400 uppercase text-sm mb-2">Investment Goal</span>
      <span class="text-2xl font-bold">{{ portfolio.investmentGoal }}</span>
    </div>
    <div class="card-hover bg-[#101a2b] rounded-xl p-6 shadow-md border border-[#1a2238] flex flex-col">
      <span class="text-gray-400 uppercase text-sm mb-2">Risk Tolerance</span>
      <span class="text-2xl font-bold">{{ portfolio.riskTolerance }}</span>
    </div>
  </section>

  <!-- Portfolio Holdings Table -->
  <section class="bg-[#101a2b] rounded-xl p-6 shadow-lg border border-[#1a2238] overflow-x-auto">
    <h2 class="text-xl font-bold text-[#1e90ff] mb-4">Portfolio Holdings</h2>
    {% if stock_data %}
    <table class="min-w-full table-auto border-collapse">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Qty</th>
          <th>Avg Buy</th>
          <th>Current Price</th>
          <th>Value</th>
          <th>P&L</th>
          <th>% of Portfolio</th>
        </tr>
      </thead>
      <tbody>
        {% for stock in stock_data %}
        {% with stock_pnl=stock.pnl|floatformat:"2" %}
        <tr class="hover:bg-[#0d1323] transition-all">
          <td class="flex items-center justify-center space-x-2">
            <div>{{ stock.symbol }}</div>
            <div>
              {% if stock.symbol in favorite_symbols %}
              <form action="{% url 'removeFavoriteStock' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="symbol" value="{{ stock.symbol }}">
                <button class="fav-button text-yellow-400" title="Remove favorite">★</button>
              </form>
              {% else %}
              <form action="{% url 'addFavoriteStock' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="symbol" value="{{ stock.symbol }}">
                <input type="hidden" name="name" value="{{ stock.symbol }}">
                <button class="fav-button text-gray-400" title="Add favorite">☆</button>
              </form>
              {% endif %}
            </div>
          </td>
          <td>{{ stock.owned_qty }}</td>
          <td>${{ stock.avg_buy_price }}</td>
          <td>${{ stock.current_price }}</td>
          <td>${{ stock.holding_value }}</td>
          <td class="font-bold {% if stock_pnl|stringformat:"s"|slice:":1" != "-" %}text-green-400{% else %}text-red-500{% endif %}">
            {% if stock_pnl|stringformat:"s"|slice:":1" != "-" %}▲{% else %}▼{% endif %} ${{ stock.pnl }}
          </td>
          <td>
            <div class="bg-gray-700 rounded-full h-3 w-full">
              <div class="progress-bar" style="width: {{ stock.percent }}%"></div>
            </div>
          </td>
        </tr>
        {% endwith %}
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p class="text-gray-400">No holdings yet.</p>
    {% endif %}
  </section>

  <!-- Portfolio Description & Diversification Chart -->
  <section class="grid md:grid-cols-2 gap-6">
    <div class="bg-[#101a2b] rounded-xl p-6 shadow-lg border border-[#1a2238] max-h-72 overflow-y-auto">
      <h3 class="text-xl font-bold text-[#1e90ff] mb-3">Portfolio Description</h3>
      <p class="text-gray-300 mb-4">{{ portfolio.description }}</p>
      <p class="text-gray-500 text-sm"><strong>Created At:</strong> {{ portfolio.createdAt|date:"M j, Y" }}</p>
    </div>

    <div class="bg-[#101a2b] rounded-xl p-6 shadow-lg border border-[#1a2238] flex flex-col items-center justify-center">
      <h3 class="text-xl font-bold text-[#1e90ff] mb-3">Portfolio Diversification</h3>
      {% if diversification %}
        <canvas id="diversificationChart" class="w-full max-w-xs h-48"></canvas>
      {% else %}
        <p class="text-gray-400">No diversification data available.</p>
      {% endif %}
    </div>
  </section>

</main>

<footer class="bg-gradient-to-r from-[#04070f] to-[#1a2238] text-gray-400 text-center py-6 text-sm border-t border-[#2c3550]">
  © 2025 FinSight. All rights reserved.
</footer>

{% if diversification %}
<script>
const diversificationData = {{ diversification|safe }};
const labels = Object.keys(diversificationData);
const data = Object.values(diversificationData);
const ctx = document.getElementById('diversificationChart').getContext('2d');
new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: labels,
    datasets: [{
      label: 'Portfolio Diversification',
      data: data,
      backgroundColor: [
        '#1e90ff', '#3c83f6', '#0b5ed7',
        '#ff7f50', '#ffa500', '#32cd32',
        '#ff69b4', '#8a2be2'
      ],
      borderColor: '#0a0f1c',
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'bottom', labels: { color: '#eaecef', font: { size: 14 } } },
      tooltip: { callbacks: { label: function(ctx){ return ctx.label + ': ' + ctx.raw + '%'; } } }
    }
  }
});
</script>
{% endif %}
</body>
</html>
